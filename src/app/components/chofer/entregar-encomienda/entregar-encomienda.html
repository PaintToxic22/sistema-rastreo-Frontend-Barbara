<div class="container-fluid min-vh-100 entrega-bg">
  <!-- HEADER -->
  <div class="header-entrega">
    <div class="container-xl">
      <div class="row align-items-center">
        <div class="col">
          <h2 class="mb-1">
            <i class="fas fa-check-circle"></i> Confirmar Entrega
          </h2>
          <small>Completa los datos del recibidor</small>
        </div>
        <div class="col-auto">
          <span class="me-3 text-light"> {{ usuario?.nombre }}</span>
          <button class="btn btn-light btn-sm" (click)="logout()">
            <i class="fas fa-sign-out-alt"></i> Salir
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTENIDO -->
  <div class="container-xl mt-4 mb-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">

        <!-- ALERTAS -->
        <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-circle"></i>
          <strong>Error:</strong> {{ error }}
          <button type="button" class="btn-close" (click)="error = ''"></button>
        </div>

        <div *ngIf="success" class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle"></i>
          <strong>隆xito!</strong> Entrega confirmada correctamente. Redirigiendo...
        </div>

        <!-- CARD INFORMACIN DE ENCOMIENDA -->
        <div *ngIf="encomienda" class="card mb-4 info-card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">
              <i class="fas fa-box"></i> Informaci贸n de la Encomienda
            </h5>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <h6 class="text-muted mb-2">C贸digo de Seguimiento</h6>
                <p class="fw-bold" style="font-size: 1.1rem;">{{ encomienda.codigoSeguimiento }}</p>
              </div>
              <div class="col-md-6">
                <h6 class="text-muted mb-2">Valor</h6>
                <p class="fw-bold" style="font-size: 1.1rem; color: #28a745;">
                  ${{ encomienda.valor | number }}
                </p>
              </div>
            </div>

            <hr class="my-3">

            <div class="row">
              <div class="col-md-6">
                <h6 class="text-muted mb-2"> Destinatario</h6>
                <p class="mb-1"><strong>{{ encomienda.destinatario?.nombre }}</strong></p>
                <p class="mb-1 small">{{ encomienda.destinatario?.direccion }}</p>
                <p class="mb-0 small">{{ encomienda.destinatario?.ciudad }}</p>
              </div>
              <div class="col-md-6">
                <h6 class="text-muted mb-2"> Detalles</h6>
                <p class="mb-1 small"><strong>Peso:</strong> {{ encomienda.peso || 'N/A' }} kg</p>
                <p class="mb-1 small"><strong>Descripci贸n:</strong> {{ encomienda.descripcion }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- FORMULARIO DE ENTREGA -->
        <div class="card mb-4">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">
              <i class="fas fa-user-check"></i> Datos del Recibidor
            </h5>
          </div>
          <div class="card-body">
            <form [formGroup]="formEntrega" (ngSubmit)="entregarEncomienda()">
              
              <!-- Nombre (REQUERIDO) -->
              <div class="mb-4">
                <label class="form-label">
                  <strong>Nombre de quien recibe</strong>
                  <span class="text-danger">*</span> (Requerido)
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg"
                  placeholder="Ej: Carlos Gonz谩lez"
                  formControlName="nombreRecibidor"
                  [class.is-invalid]="nombreInvalido"
                >
                <small class="text-muted d-block mt-2">
                   Nombre completo de la persona que recibe la encomienda
                </small>
                <div class="invalid-feedback" *ngIf="nombreInvalido">
                  Nombre requerido (m铆nimo 3 caracteres)
                </div>
              </div>

              <!-- RUT (OPCIONAL) -->
              <div class="mb-4">
                <label class="form-label">
                  <strong>RUT de la Persona</strong>
                  <span class="text-muted">(Opcional)</span>
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg"
                  placeholder="12.345.678-9"
                  formControlName="rutRecibidor"
                  (input)="formatearRUT($event)"
                >
                <small class="text-muted d-block mt-2">
                   Formato: XX.XXX.XXX-X (opcional, se completa autom谩ticamente)
                </small>
              </div>

              <!-- Notas -->
              <div class="mb-4">
                <label class="form-label">
                  <strong>Notas / Ubicaci贸n Espec铆fica</strong>
                  <span class="text-muted">(Opcional)</span>
                </label>
                <textarea 
                  class="form-control"
                  placeholder="Ej: Junto a farmacia, casa con port贸n azul, piso 3"
                  formControlName="notas"
                  rows="3"
                ></textarea>
                <small class="text-muted d-block mt-2">
                   Referencia para futuras entregas
                </small>
              </div>

              <!-- Foto (OPCIONAL) -->
              <div class="mb-4">
                <label class="form-label">
                  <strong>Foto de la Entrega</strong>
                  <span class="text-muted">(Opcional)</span>
                </label>
                <div class="input-group mb-3">
                  <input 
                    type="file" 
                    class="form-control"
                    id="fotoInput"
                    accept="image/*"
                    (change)="onFotoSelected($event)"
                  >
                  <label class="input-group-text" for="fotoInput">
                    <i class="fas fa-camera"></i> Seleccionar
                  </label>
                </div>
                <img 
                  *ngIf="fotoPreview" 
                  [src]="fotoPreview" 
                  alt="preview" 
                  class="img-thumbnail mt-2" 
                  style="max-width: 250px; max-height: 250px;"
                >
                <small class="text-muted d-block mt-2">
                   M谩ximo 5MB. Formatos: JPG, PNG, etc.
                </small>
              </div>

              <!-- INFORMACIN IMPORTANTE -->
              <div class="alert alert-info mb-4">
                <h6 class="mb-2">
                  <i class="fas fa-info-circle"></i> Informaci贸n Importante
                </h6>
                <ul class="mb-0 small">
                  <li><strong>Nombre:</strong> Campo obligatorio</li>
                  <li><strong>RUT:</strong> Campo opcional (puede dejarse vac铆o)</li>
                  <li>Se guardar谩 autom谩ticamente: fecha, hora y tu ubicaci贸n</li>
                  <li>Aseg煤rate de que la persona firme o confirme la recepci贸n</li>
                </ul>
              </div>

              <!-- BOTONES -->
              <div class="d-flex gap-2">
                <button 
                  type="submit" 
                  class="btn btn-success btn-lg flex-grow-1"
                  [disabled]="loading || formEntrega.invalid"
                >
                  <span *ngIf="!loading">
                    <i class="fas fa-check-circle"></i> Confirmar Entrega
                  </span>
                  <span *ngIf="loading">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Confirmando...
                  </span>
                </button>

                <button 
                  type="button" 
                  class="btn btn-secondary btn-lg"
                  (click)="volver()"
                  [disabled]="loading"
                >
                  <i class="fas fa-arrow-left"></i> Volver
                </button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>